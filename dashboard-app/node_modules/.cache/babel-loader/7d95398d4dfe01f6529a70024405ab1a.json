{"ast":null,"code":"'use strict';\n\nfunction _interopDefault(ex) {\n  return ex && typeof ex === 'object' && 'default' in ex ? ex['default'] : ex;\n}\n\nvar _objectSpread2 = _interopDefault(require('@babel/runtime/helpers/objectSpread'));\n\nvar _objectWithoutProperties = _interopDefault(require('@babel/runtime/helpers/objectWithoutProperties'));\n\nrequire('core-js/modules/es6.array.filter');\n\nrequire('core-js/modules/es6.array.find');\n\nrequire('core-js/modules/es6.promise');\n\nrequire('core-js/modules/web.dom.iterable');\n\nrequire('core-js/modules/es6.array.iterator');\n\nrequire('core-js/modules/es6.object.to-string');\n\nrequire('core-js/modules/es6.object.keys');\n\nrequire('core-js/modules/es6.array.for-each');\n\nvar _regeneratorRuntime = _interopDefault(require('@babel/runtime/regenerator'));\n\nvar _asyncToGenerator = _interopDefault(require('@babel/runtime/helpers/asyncToGenerator'));\n\nvar _classCallCheck = _interopDefault(require('@babel/runtime/helpers/classCallCheck'));\n\nvar _createClass = _interopDefault(require('@babel/runtime/helpers/createClass'));\n\nvar WebSocket = _interopDefault(require('isomorphic-ws'));\n\nvar WebSocketTransportResult = /*#__PURE__*/function () {\n  function WebSocketTransportResult(_ref) {\n    var status = _ref.status,\n        message = _ref.message;\n\n    _classCallCheck(this, WebSocketTransportResult);\n\n    this.status = status;\n    this.result = message;\n  }\n\n  _createClass(WebSocketTransportResult, [{\n    key: \"json\",\n    value: function () {\n      var _json = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                return _context.abrupt(\"return\", this.result);\n\n              case 1:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function json() {\n        return _json.apply(this, arguments);\n      }\n\n      return json;\n    }()\n  }]);\n\n  return WebSocketTransportResult;\n}();\n\nvar WebSocketTransport = /*#__PURE__*/function () {\n  function WebSocketTransport(_ref2) {\n    var authorization = _ref2.authorization,\n        apiUrl = _ref2.apiUrl,\n        hearBeatInterval = _ref2.hearBeatInterval;\n\n    _classCallCheck(this, WebSocketTransport);\n\n    this.authorization = authorization;\n    this.apiUrl = apiUrl;\n    this.messageCounter = 1;\n    this.messageIdToSubscription = {};\n    this.messageQueue = [];\n    this.hearBeatInterval = hearBeatInterval || 60;\n  }\n\n  _createClass(WebSocketTransport, [{\n    key: \"initSocket\",\n    value: function initSocket() {\n      var _this = this;\n\n      if (this.ws) {\n        return this.ws.initPromise;\n      }\n\n      var ws = new WebSocket(this.apiUrl);\n      ws.messageIdSent = {};\n\n      ws.sendMessage = function (message) {\n        if (!message.messageId || message.messageId && !ws.messageIdSent[message.messageId]) {\n          ws.send(JSON.stringify(message));\n          ws.messageIdSent[message.messageId] = true;\n        }\n      };\n\n      ws.sendQueue = function () {\n        _this.messageQueue.forEach(function (message) {\n          return ws.sendMessage(message);\n        });\n\n        _this.messageQueue = [];\n      };\n\n      ws.reconcile = function () {\n        if (new Date().getTime() - ws.lastMessageTimestamp.getTime() > 4 * _this.hearBeatInterval * 1000) {\n          ws.close();\n        } else {\n          Object.keys(_this.messageIdToSubscription).forEach(function (messageId) {\n            ws.sendMessage(_this.messageIdToSubscription[messageId].message);\n          });\n        }\n      };\n\n      ws.lastMessageTimestamp = new Date();\n      ws.initPromise = new Promise(function (resolve) {\n        ws.onopen = function () {\n          ws.sendMessage({\n            authorization: _this.authorization\n          });\n        };\n\n        ws.onmessage = function (message) {\n          ws.lastMessageTimestamp = new Date();\n          message = JSON.parse(message.data);\n\n          if (message.handshake) {\n            ws.reconcile();\n            ws.reconcileTimer = setInterval(function () {\n              ws.messageIdSent = {};\n              ws.reconcile();\n            }, _this.hearBeatInterval * 1000);\n            resolve();\n          }\n\n          if (_this.messageIdToSubscription[message.messageId]) {\n            _this.messageIdToSubscription[message.messageId].callback(new WebSocketTransportResult(message));\n          }\n\n          ws.sendQueue();\n        };\n\n        ws.onclose = function () {\n          if (ws && ws.readyState !== WebSocket.CLOSED && ws.readyState !== WebSocket.CLOSING) {\n            ws.close();\n          }\n\n          if (ws.reconcileTimer) {\n            clearInterval(ws.reconcileTimer);\n            ws.reconcileTimer = null;\n          }\n\n          if (_this.ws === ws) {\n            _this.ws = null;\n\n            if (Object.keys(_this.messageIdToSubscription).length) {\n              _this.initSocket();\n            }\n          }\n        };\n\n        ws.onerror = ws.onclose;\n      });\n      this.ws = ws;\n      return this.ws.initPromise;\n    }\n  }, {\n    key: \"sendMessage\",\n    value: function sendMessage(message) {\n      var _this2 = this;\n\n      if (message.unsubscribe && this.messageQueue.find(function (m) {\n        return m.messageId === message.unsubscribe;\n      })) {\n        this.messageQueue = this.messageQueue.filter(function (m) {\n          return m.messageId !== message.unsubscribe;\n        });\n      } else {\n        this.messageQueue.push(message);\n      }\n\n      setTimeout( /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                _context2.next = 2;\n                return _this2.initSocket();\n\n              case 2:\n                _this2.ws.sendQueue();\n\n              case 3:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2);\n      })), 100);\n    }\n  }, {\n    key: \"request\",\n    value: function request(method, _ref4) {\n      var baseRequestId = _ref4.baseRequestId,\n          params = _objectWithoutProperties(_ref4, [\"baseRequestId\"]);\n\n      var message = {\n        messageId: this.messageCounter++,\n        method: method,\n        params: params\n      };\n      var pendingResults = [];\n      var nextMessage = null;\n\n      var runNextMessage = function runNextMessage() {\n        if (nextMessage) {\n          nextMessage(pendingResults.pop());\n          nextMessage = null;\n        }\n      };\n\n      this.messageIdToSubscription[message.messageId] = {\n        message: message,\n        callback: function callback(result) {\n          pendingResults.push(result);\n          runNextMessage();\n        }\n      };\n      var transport = this;\n      var spanCounter = 1;\n      return {\n        subscribe: function subscribe(callback) {\n          var _this3 = this;\n\n          return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3() {\n            var result;\n            return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n              while (1) {\n                switch (_context3.prev = _context3.next) {\n                  case 0:\n                    transport.sendMessage(_objectSpread2({\n                      requestId: baseRequestId && \"\".concat(baseRequestId, \"-span-\").concat(spanCounter++)\n                    }, message));\n                    _context3.next = 3;\n                    return new Promise(function (resolve) {\n                      nextMessage = resolve;\n\n                      if (pendingResults.length) {\n                        runNextMessage();\n                      }\n                    });\n\n                  case 3:\n                    result = _context3.sent;\n                    return _context3.abrupt(\"return\", callback(result, function () {\n                      return _this3.subscribe(callback);\n                    }));\n\n                  case 5:\n                  case \"end\":\n                    return _context3.stop();\n                }\n              }\n            }, _callee3);\n          }))();\n        },\n        unsubscribe: function unsubscribe() {\n          return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4() {\n            return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n              while (1) {\n                switch (_context4.prev = _context4.next) {\n                  case 0:\n                    transport.sendMessage({\n                      unsubscribe: message.messageId\n                    });\n                    delete transport.messageIdToSubscription[message.messageId];\n\n                  case 2:\n                  case \"end\":\n                    return _context4.stop();\n                }\n              }\n            }, _callee4);\n          }))();\n        }\n      };\n    }\n  }, {\n    key: \"authorization\",\n    set: function set(token) {\n      this.token = token;\n\n      if (this.ws) {\n        this.ws.close();\n      }\n    },\n    get: function get() {\n      return this.token;\n    }\n  }]);\n\n  return WebSocketTransport;\n}();\n\nmodule.exports = WebSocketTransport;","map":{"version":3,"sources":["/home/syb234/dashboard/dashboard-backend/dashboard-app/node_modules/@cubejs-client/ws-transport/dist/cubejs-client-ws-transport.js"],"names":["_interopDefault","ex","_objectSpread2","require","_objectWithoutProperties","_regeneratorRuntime","_asyncToGenerator","_classCallCheck","_createClass","WebSocket","WebSocketTransportResult","_ref","status","message","result","key","value","_json","mark","_callee","wrap","_callee$","_context","prev","next","abrupt","stop","json","apply","arguments","WebSocketTransport","_ref2","authorization","apiUrl","hearBeatInterval","messageCounter","messageIdToSubscription","messageQueue","initSocket","_this","ws","initPromise","messageIdSent","sendMessage","messageId","send","JSON","stringify","sendQueue","forEach","reconcile","Date","getTime","lastMessageTimestamp","close","Object","keys","Promise","resolve","onopen","onmessage","parse","data","handshake","reconcileTimer","setInterval","callback","onclose","readyState","CLOSED","CLOSING","clearInterval","length","onerror","_this2","unsubscribe","find","m","filter","push","setTimeout","_callee2","_callee2$","_context2","request","method","_ref4","baseRequestId","params","pendingResults","nextMessage","runNextMessage","pop","transport","spanCounter","subscribe","_this3","_callee3","_callee3$","_context3","requestId","concat","sent","_callee4","_callee4$","_context4","set","token","get","module","exports"],"mappings":"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","sourcesContent":["'use strict';\n\nfunction _interopDefault (ex) { return (ex && (typeof ex === 'object') && 'default' in ex) ? ex['default'] : ex; }\n\nvar _objectSpread2 = _interopDefault(require('@babel/runtime/helpers/objectSpread'));\nvar _objectWithoutProperties = _interopDefault(require('@babel/runtime/helpers/objectWithoutProperties'));\nrequire('core-js/modules/es6.array.filter');\nrequire('core-js/modules/es6.array.find');\nrequire('core-js/modules/es6.promise');\nrequire('core-js/modules/web.dom.iterable');\nrequire('core-js/modules/es6.array.iterator');\nrequire('core-js/modules/es6.object.to-string');\nrequire('core-js/modules/es6.object.keys');\nrequire('core-js/modules/es6.array.for-each');\nvar _regeneratorRuntime = _interopDefault(require('@babel/runtime/regenerator'));\nrequire('regenerator-runtime/runtime');\nvar _asyncToGenerator = _interopDefault(require('@babel/runtime/helpers/asyncToGenerator'));\nvar _classCallCheck = _interopDefault(require('@babel/runtime/helpers/classCallCheck'));\nvar _createClass = _interopDefault(require('@babel/runtime/helpers/createClass'));\nvar WebSocket = _interopDefault(require('isomorphic-ws'));\n\nvar WebSocketTransportResult =\n/*#__PURE__*/\nfunction () {\n  function WebSocketTransportResult(_ref) {\n    var status = _ref.status,\n        message = _ref.message;\n\n    _classCallCheck(this, WebSocketTransportResult);\n\n    this.status = status;\n    this.result = message;\n  }\n\n  _createClass(WebSocketTransportResult, [{\n    key: \"json\",\n    value: function () {\n      var _json = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee() {\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                return _context.abrupt(\"return\", this.result);\n\n              case 1:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function json() {\n        return _json.apply(this, arguments);\n      }\n\n      return json;\n    }()\n  }]);\n\n  return WebSocketTransportResult;\n}();\n\nvar WebSocketTransport =\n/*#__PURE__*/\nfunction () {\n  function WebSocketTransport(_ref2) {\n    var authorization = _ref2.authorization,\n        apiUrl = _ref2.apiUrl,\n        hearBeatInterval = _ref2.hearBeatInterval;\n\n    _classCallCheck(this, WebSocketTransport);\n\n    this.authorization = authorization;\n    this.apiUrl = apiUrl;\n    this.messageCounter = 1;\n    this.messageIdToSubscription = {};\n    this.messageQueue = [];\n    this.hearBeatInterval = hearBeatInterval || 60;\n  }\n\n  _createClass(WebSocketTransport, [{\n    key: \"initSocket\",\n    value: function initSocket() {\n      var _this = this;\n\n      if (this.ws) {\n        return this.ws.initPromise;\n      }\n\n      var ws = new WebSocket(this.apiUrl);\n      ws.messageIdSent = {};\n\n      ws.sendMessage = function (message) {\n        if (!message.messageId || message.messageId && !ws.messageIdSent[message.messageId]) {\n          ws.send(JSON.stringify(message));\n          ws.messageIdSent[message.messageId] = true;\n        }\n      };\n\n      ws.sendQueue = function () {\n        _this.messageQueue.forEach(function (message) {\n          return ws.sendMessage(message);\n        });\n\n        _this.messageQueue = [];\n      };\n\n      ws.reconcile = function () {\n        if (new Date().getTime() - ws.lastMessageTimestamp.getTime() > 4 * _this.hearBeatInterval * 1000) {\n          ws.close();\n        } else {\n          Object.keys(_this.messageIdToSubscription).forEach(function (messageId) {\n            ws.sendMessage(_this.messageIdToSubscription[messageId].message);\n          });\n        }\n      };\n\n      ws.lastMessageTimestamp = new Date();\n      ws.initPromise = new Promise(function (resolve) {\n        ws.onopen = function () {\n          ws.sendMessage({\n            authorization: _this.authorization\n          });\n        };\n\n        ws.onmessage = function (message) {\n          ws.lastMessageTimestamp = new Date();\n          message = JSON.parse(message.data);\n\n          if (message.handshake) {\n            ws.reconcile();\n            ws.reconcileTimer = setInterval(function () {\n              ws.messageIdSent = {};\n              ws.reconcile();\n            }, _this.hearBeatInterval * 1000);\n            resolve();\n          }\n\n          if (_this.messageIdToSubscription[message.messageId]) {\n            _this.messageIdToSubscription[message.messageId].callback(new WebSocketTransportResult(message));\n          }\n\n          ws.sendQueue();\n        };\n\n        ws.onclose = function () {\n          if (ws && ws.readyState !== WebSocket.CLOSED && ws.readyState !== WebSocket.CLOSING) {\n            ws.close();\n          }\n\n          if (ws.reconcileTimer) {\n            clearInterval(ws.reconcileTimer);\n            ws.reconcileTimer = null;\n          }\n\n          if (_this.ws === ws) {\n            _this.ws = null;\n\n            if (Object.keys(_this.messageIdToSubscription).length) {\n              _this.initSocket();\n            }\n          }\n        };\n\n        ws.onerror = ws.onclose;\n      });\n      this.ws = ws;\n      return this.ws.initPromise;\n    }\n  }, {\n    key: \"sendMessage\",\n    value: function sendMessage(message) {\n      var _this2 = this;\n\n      if (message.unsubscribe && this.messageQueue.find(function (m) {\n        return m.messageId === message.unsubscribe;\n      })) {\n        this.messageQueue = this.messageQueue.filter(function (m) {\n          return m.messageId !== message.unsubscribe;\n        });\n      } else {\n        this.messageQueue.push(message);\n      }\n\n      setTimeout(\n      /*#__PURE__*/\n      _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee2() {\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                _context2.next = 2;\n                return _this2.initSocket();\n\n              case 2:\n                _this2.ws.sendQueue();\n\n              case 3:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2);\n      })), 100);\n    }\n  }, {\n    key: \"request\",\n    value: function request(method, _ref4) {\n      var baseRequestId = _ref4.baseRequestId,\n          params = _objectWithoutProperties(_ref4, [\"baseRequestId\"]);\n\n      var message = {\n        messageId: this.messageCounter++,\n        method: method,\n        params: params\n      };\n      var pendingResults = [];\n      var nextMessage = null;\n\n      var runNextMessage = function runNextMessage() {\n        if (nextMessage) {\n          nextMessage(pendingResults.pop());\n          nextMessage = null;\n        }\n      };\n\n      this.messageIdToSubscription[message.messageId] = {\n        message: message,\n        callback: function callback(result) {\n          pendingResults.push(result);\n          runNextMessage();\n        }\n      };\n      var transport = this;\n      var spanCounter = 1;\n      return {\n        subscribe: function subscribe(callback) {\n          var _this3 = this;\n\n          return _asyncToGenerator(\n          /*#__PURE__*/\n          _regeneratorRuntime.mark(function _callee3() {\n            var result;\n            return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n              while (1) {\n                switch (_context3.prev = _context3.next) {\n                  case 0:\n                    transport.sendMessage(_objectSpread2({\n                      requestId: baseRequestId && \"\".concat(baseRequestId, \"-span-\").concat(spanCounter++)\n                    }, message));\n                    _context3.next = 3;\n                    return new Promise(function (resolve) {\n                      nextMessage = resolve;\n\n                      if (pendingResults.length) {\n                        runNextMessage();\n                      }\n                    });\n\n                  case 3:\n                    result = _context3.sent;\n                    return _context3.abrupt(\"return\", callback(result, function () {\n                      return _this3.subscribe(callback);\n                    }));\n\n                  case 5:\n                  case \"end\":\n                    return _context3.stop();\n                }\n              }\n            }, _callee3);\n          }))();\n        },\n        unsubscribe: function unsubscribe() {\n          return _asyncToGenerator(\n          /*#__PURE__*/\n          _regeneratorRuntime.mark(function _callee4() {\n            return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n              while (1) {\n                switch (_context4.prev = _context4.next) {\n                  case 0:\n                    transport.sendMessage({\n                      unsubscribe: message.messageId\n                    });\n                    delete transport.messageIdToSubscription[message.messageId];\n\n                  case 2:\n                  case \"end\":\n                    return _context4.stop();\n                }\n              }\n            }, _callee4);\n          }))();\n        }\n      };\n    }\n  }, {\n    key: \"authorization\",\n    set: function set(token) {\n      this.token = token;\n\n      if (this.ws) {\n        this.ws.close();\n      }\n    },\n    get: function get() {\n      return this.token;\n    }\n  }]);\n\n  return WebSocketTransport;\n}();\n\nmodule.exports = WebSocketTransport;\n"]},"metadata":{},"sourceType":"script"}